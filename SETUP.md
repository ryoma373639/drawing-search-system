# セットアップガイド

このドキュメントでは、図面検索システムのビルドとデプロイ手順を説明します。

## 開発環境のセットアップ

### 1. Node.jsのインストール

1. https://nodejs.org/ にアクセス
2. LTS版（推奨版）をダウンロード
3. インストーラーを実行

### 2. 依存関係のインストール

```bash
cd drawing-search-system
npm install
```

初回インストール時、以下の依存関係がインストールされます：

- **Electron**: デスクトップアプリフレームワーク
- **better-sqlite3**: SQLiteデータベース
- **chokidar**: ファイル監視
- **pdf-parse**: PDF解析
- **tesseract.js**: OCR（光学文字認識）
- **dxf-parser**: CAD図面解析

インストールには5-10分程度かかります。

### 3. 開発モードで起動

```bash
npm start
```

アプリが起動します。開発中は、コードを変更したら再起動が必要です。

## Windows版インストーラーのビルド

### 1. ビルド実行

```bash
npm run build:win
```

ビルドには10-15分程度かかります。

### 2. 成果物の確認

ビルド完了後、`dist/` フォルダに以下のファイルが生成されます：

```
dist/
├── 図面検索システム Setup 1.0.0.exe  （インストーラー）
└── win-unpacked/                      （ポータブル版）
    └── 図面検索システム.exe
```

### 3. インストーラーの配布

`図面検索システム Setup 1.0.0.exe` を各PCに配布してインストールします。

## 各PCへのデプロイ手順

### 方法1: ネットワーク共有フォルダ経由

1. インストーラーをネットワーク共有フォルダに配置
2. 各ユーザーに共有フォルダのパスを通知
3. ユーザーが自分でインストール

### 方法2: USBメモリ経由

1. インストーラーをUSBメモリにコピー
2. 各PCでUSBから実行してインストール

### 方法3: リモートデスクトップ経由

1. リモートデスクトップで各PCに接続
2. インストーラーを転送してインストール

## 初回起動時の設定（ユーザー向け）

### 1. アプリを起動

デスクトップのショートカットをダブルクリック

### 2. Dropboxフォルダを設定

1. 右上の「⚙️ 設定」ボタンをクリック
2. 「フォルダを選択」をクリック
3. Dropboxフォルダを選択（例: `C:\Users\XXX\Dropbox\図面`）
4. 「閉じる」をクリック

### 3. インデックス作成を待つ

- 自動的にインデックス作成が開始されます
- 進捗バーで進行状況を確認できます
- 10,000枚の図面で約30分〜1時間かかります
- この間も他の作業を続けられます

### 4. 検索開始

インデックス作成完了後、すぐに検索が可能になります。

## トラブルシューティング

### ビルドエラー

#### `gyp ERR!` が表示される

**原因**: better-sqlite3のネイティブモジュールビルドエラー

**対処法**:
1. Visual Studio Build Toolsをインストール
   - https://visualstudio.microsoft.com/ja/downloads/
   - 「Build Tools for Visual Studio」をダウンロード
   - 「C++によるデスクトップ開発」を選択してインストール

2. 再度ビルド実行
   ```bash
   npm install
   npm run build:win
   ```

#### `ENOSPC` エラー

**原因**: ディスク容量不足

**対処法**: 不要なファイルを削除して空き容量を確保（5GB以上推奨）

### インストールエラー

#### 「このアプリはお使いのPCでは実行できません」

**原因**: 32bit OSまたは古いWindows

**対処法**: Windows 10/11の64bit版が必要です

#### 「セキュリティ警告」が表示される

**原因**: デジタル署名がない

**対処法**:
1. 「詳細情報」をクリック
2. 「実行する」をクリック

（本番環境では、コードサイニング証明書で署名することを推奨）

### 実行エラー

#### アプリが起動しない

**確認事項**:
1. Node.jsがインストールされているか（開発環境のみ）
2. Windowsが最新の状態か
3. ウイルス対策ソフトがブロックしていないか

**対処法**: ウイルス対策ソフトの除外設定に追加

#### Dropboxフォルダが選択できない

**原因**: Dropboxが同期されていない

**対処法**: Dropboxアプリを起動して同期を確認

## アップデート手順

新バージョンをリリースする場合:

### 1. バージョン番号を更新

`package.json` の `version` を更新:

```json
{
  "version": "1.1.0"  // 1.0.0 → 1.1.0
}
```

### 2. 再ビルド

```bash
npm run build:win
```

### 3. 配布

新しいインストーラーを配布。既存バージョンに上書きインストール可能。

## 設定ファイルの場所

各ユーザーのPCでは、以下の場所に設定が保存されます:

```
C:\Users\[ユーザー名]\AppData\Roaming\drawing-search-system\
├── drawings.db         （インデックスDB）
└── drawings.db-wal     （SQLite WALファイル）
```

アンインストール時、このフォルダは自動削除されません（手動削除が必要）。

## パフォーマンスチューニング

### インデックス作成の高速化

`indexer.js` の以下の行を調整:

```javascript
// 少し待機（CPU負荷軽減）
await new Promise(resolve => setTimeout(resolve, 100));
```

`100` → `50` に変更すると高速化（ただしCPU負荷が上がる）

### 検索結果の件数上限

`search.js` の `LIMIT 100` を変更:

```javascript
SELECT * FROM drawings
ORDER BY updated_at DESC
LIMIT 100  // ← この値を変更（例: 500）
```

### OCRの無効化（速度優先）

画像のOCRが不要な場合、`indexer.js` の以下の部分をコメントアウト:

```javascript
} else if (['.jpg', '.jpeg', '.png', '.tiff', '.tif'].includes(fileExt)) {
  // const extracted = await extractFromImage(filePath);
  // partName = extracted.partName;
  // clientName = extracted.clientName;
}
```

## セキュリティ

### データの保護

- インデックスDBは暗号化されていません
- 機密性の高い図面を扱う場合は、PC自体を暗号化（BitLocker等）することを推奨

### ネットワークセキュリティ

- このアプリは外部通信を行いません
- ファイアウォールの設定は不要

## バックアップ

インデックスDBのバックアップ:

1. `C:\Users\[ユーザー名]\AppData\Roaming\drawing-search-system\` フォルダをコピー
2. 外部ドライブまたはネットワークドライブに保存

復元:
1. アプリを終了
2. バックアップからフォルダを上書き
3. アプリを再起動

---

**問題が解決しない場合**: README.mdのトラブルシューティングセクションも参照してください。
